let i=!1,S=0,d=null,L=null;const v=async t=>{const{targetReps:o=10,totalSets:s=3,currentSet:p=1,userEmail:m,cameraFacing:r="user",videoRef:n,onFeedback:u,onComplete:w}=t;try{await _(),d=new window.Pose({locateFile:h=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${h}`}),await d.setOptions({modelComplexity:1,smoothLandmarks:!0,enableSegmentation:!1,minDetectionConfidence:.5,minTrackingConfidence:.5,selfieMode:r==="user",upperBodyOnly:!0});let e=0,f=0,y=o*s;return d.onResults(h=>{const g=T(h,{currentSetReps:e,targetRepsPerSet:o,totalReps:f,totalTargetReps:y});g.repCount>e&&(e=g.repCount,f++,e>=o&&(w({completed:!0,reps:e,feedback:`Set ${p} complete! ${e}/${o} reps`,currentSet:p}),e=0,S=0)),u&&u(g.feedback)}),L=new window.Camera(n.current,{onFrame:async()=>{n.current&&await d.send({image:n.current})},width:640,height:480,facingMode:r==="user"?"user":"environment"}),await L.start(),console.log("Push-up monitoring started"),{stop:()=>{L&&L.stop(),d&&d.close(),console.log("Push-up monitoring stopped")}}}catch(e){throw console.error("Error initializing push-up monitoring:",e),e}},T=(t,{currentSetReps:o,targetRepsPerSet:s,totalReps:p,totalTargetReps:m})=>{if(!t.poseLandmarks)return{feedback:"No person detected.",repCount:o};const r=t.poseLandmarks[11],n=t.poseLandmarks[12],u=t.poseLandmarks[13],w=t.poseLandmarks[14],e=t.poseLandmarks[15],f=t.poseLandmarks[16];if(!r||!n||!u||!w||!e||!f)return{feedback:"Please position yourself correctly in the frame.",repCount:o};const y=(E,k,C)=>{const b=Math.hypot(k.x-E.x,k.y-E.y),R=Math.hypot(C.x-k.x,C.y-k.y),x=Math.hypot(C.x-E.x,C.y-E.y),$=(b**2+R**2-x**2)/(2*b*R),A=Math.max(-1,Math.min(1,$));return Math.acos(A)*(180/Math.PI)},h=y(r,u,e),g=y(n,w,f),l=(h+g)/2,P=120,D=145,M=160;let c="Starting push-ups...",a=o;return!i&&l<P?(i=!0,c="Down position detected - push back up!"):!i&&l<D&&l>=P?(i=!0,c="Partial down detected - try to go lower!"):i&&l>M&&(i=!1,a===S&&(a++,S=a,c=`Rep ${a} completed! ${a>=s?"Set complete!":""}`)),!i&&l>M&&a>0&&(c=`Ready for rep ${a+1}. Current: ${a}/${s}`),a>=s&&(c="Set complete! Take a rest."),p>=m&&(c="Workout complete! Great job!"),{repCount:a,feedback:c,avgElbowAngle:Math.round(l),isDown:i}};async function _(){return new Promise((t,o)=>{if(window.Pose&&window.Camera){t();return}let s=0;const p=2;function m(){s++,s===p&&t()}const r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js",r.onload=m,r.onerror=()=>o(new Error("Failed to load MediaPipe Pose")),document.head.appendChild(r);const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js",n.onload=m,n.onerror=()=>o(new Error("Failed to load MediaPipe Camera Utils")),document.head.appendChild(n)})}export{v as monitorPushUps};
