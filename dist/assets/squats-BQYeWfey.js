let h=!1,w=0,T=null,H=null,q=180,m="ready",S=[];const E=async o=>{const{targetReps:e=10,totalSets:t=3,currentSet:s=1,userEmail:d,cameraFacing:r="user",videoRef:a,onFeedback:i,onComplete:c,onFormFeedback:u}=o;try{await x(),T=await window.PoseLandmarker.createFromOptions(H,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1,minPoseDetectionConfidence:.6,minPosePresenceConfidence:.6,minTrackingConfidence:.6,outputSegmentationMasks:!1});let n=0,l=0,k=e*t,f=0,g=0,b=null,y=!1;return(()=>{y=!0;const F=async()=>{if(!(!y||!a.current)){try{const A=await T.detectForVideo(a.current,performance.now()),p=C(A,{currentSetReps:n,targetRepsPerSet:e,totalReps:l,totalTargetReps:k,fullSquats:f,partialSquats:g});p.repCount>n&&(n=p.repCount,l++,p.squatType==="full"?f++:p.squatType==="partial"&&g++,n>=e&&(c({completed:!0,reps:n,fullSquats:f,partialSquats:g,feedback:`Set ${s} complete! ${n}/${e} reps`,currentSet:s}),n=0,w=0)),i&&i({...p.feedback,fullSquats:f,partialSquats:g,currentPhase:m,repCount:n}),u&&p.formFeedback&&u(p.formFeedback)}catch(A){console.error("Error during pose detection:",A)}y&&(b=requestAnimationFrame(F))}};F()})(),console.log("Squat monitoring started"),{stop:()=>{y=!1,b&&cancelAnimationFrame(b),T&&T.close(),console.log("Squat monitoring stopped")},getStats:()=>({fullSquats:f,partialSquats:g,totalReps:f+g,currentSetReps:n})}}catch(n){throw console.error("Error initializing squat monitoring:",n),n}},C=(o,{currentSetReps:e,targetRepsPerSet:t,totalReps:s,totalTargetReps:d,fullSquats:r,partialSquats:a})=>{if(!o.landmarks||o.landmarks.length===0)return{feedback:{message:"No person detected. Please step into view."},repCount:e,formFeedback:null};const i=L(o.landmarks),c=P(i.kneeAngle,e),u=M(i);let n="Starting squats...";return m==="ready"?n=`Ready for rep ${e+1}. Current: ${e}/${t}`:m==="full_squat"?n=`Perfect squat! Rep ${c.repCount} completed!`:m==="partial_squat"?n="Partial squat counted. Try to go deeper next time!":h&&(n="Push back up to complete the rep!"),c.repCount>=t&&(n="Set complete! Take a rest."),s>=d&&(n="Workout complete! Great job!"),{repCount:c.repCount,squatType:c.squatType,feedback:{message:n,avgKneeAngle:Math.round(i.kneeAngle),isDown:h,phase:m},formFeedback:u}},L=o=>{const e=o[0],t=e[23],s=e[24],d=e[25],r=e[26],a=e[27],i=e[28],c=e[11],u=e[12],n=v(t,d,a),l=v(s,r,i),k=(n+l)/2,f=v(c,t,d),g=v(u,s,r),b=(f+g)/2,y=Math.abs(d.x-r.x),R=Math.abs(t.x-s.x),F=R>0?y/R:1,A={x:(t.x+s.x)/2,y:(t.y+s.y)/2},p={x:(c.x+u.x)/2,y:(c.y+u.y)/2},_=Math.atan2(p.x-A.x,A.y-p.y)*(180/Math.PI);return{kneeAngle:k,hipAngle:b,kneeAlignment:F,torsoAngle:Math.abs(_),leftKneeAngle:n,rightKneeAngle:l,asymmetry:Math.abs(n-l)}},v=(o,e,t)=>{const s=Math.hypot(e.x-o.x,e.y-o.y),d=Math.hypot(t.x-e.x,t.y-e.y),r=Math.hypot(t.x-o.x,t.y-o.y),a=(s**2+d**2-r**2)/(2*s*d),i=Math.max(-1,Math.min(1,a)),c=Math.acos(i)*(180/Math.PI);return isNaN(c)?180:c},P=(o,e)=>{const r=q*.7+o*.3;q=r;let a=e,i=null;return!h&&r<90?(h=!0,a===w&&(a++,w=a,i="full"),m="full_squat"):!h&&r<110&&r>=90?(h=!0,a===w&&(a++,w=a,i="partial"),m="partial_squat"):h&&r>160?(h=!1,m="standing"):r>170&&(m="ready"),{repCount:a,squatType:i}},M=o=>{var u,n;const e=[];let t="good";const s=q*.7+o.kneeAngle*.3;if(s>140)return{feedback:"ðŸƒâ€â™€ï¸ Ready position - Start your squat!",className:"good-form",severity:"good"};s>130?(e.push("ðŸ”½ Go deeper!"),t="warning"):s<70?(e.push("âš ï¸ Too deep - careful!"),t="bad"):s<=90?e.push("ðŸŽ¯ Perfect depth!"):e.push("âœ… Good depth"),o.kneeAlignment<.6?(e.push("ðŸ“ Knees caving - push out!"),t="bad"):o.kneeAlignment>1.4?(e.push("ðŸ“ Knees too wide"),t="warning"):e.push("âœ… Knees aligned"),o.torsoAngle>35?(e.push("ðŸ—ï¸ Chest up!"),t="warning"):e.push("âœ… Good posture"),o.asymmetry>20&&(e.push("âš–ï¸ Balance both legs"),t="warning");const d=5,r={feedback:e.join(" | "),className:t==="good"?"good-form":t==="warning"?"warning-form":"bad-form",severity:t};S.push(r),S.length>d&&S.shift();const a={};S.forEach(l=>{a[l.feedback]=(a[l.feedback]||0)+1});const i=Object.keys(a).reduce((l,k)=>a[l]>a[k]?l:k),c=((u=S.find(l=>l.feedback===i))==null?void 0:u.className)||"good-form";return{feedback:i,className:c,severity:((n=S.find(l=>l.feedback===i))==null?void 0:n.severity)||"good"}};async function x(){return new Promise((o,e)=>{if(window.PoseLandmarker&&window.FilesetResolver){o();return}const t=document.createElement("script");t.type="module",t.innerHTML=`
      import {
        FilesetResolver,
        PoseLandmarker,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";
      
      // Make available globally
      window.FilesetResolver = FilesetResolver;
      window.PoseLandmarker = PoseLandmarker;
      
      // Initialize vision fileset
      FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
      ).then(visionFileset => {
        window.visionFileset = visionFileset;
        window.dispatchEvent(new CustomEvent('mediapipe-loaded'));
      });
    `,window.addEventListener("mediapipe-loaded",async()=>{try{H=window.visionFileset,o()}catch(s){e(s)}},{once:!0}),document.head.appendChild(t)})}export{E as monitorSquats};
