import{Camera as J}from"https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";import{U as y}from"./index-Bn0YZ9nd.js";const L=.1,B=120,f=.5;async function R({targetReps:x,totalSets:d,currentSet:i,userEmail:O,cameraFacing:A="user",videoRef:o,onFeedback:t,onComplete:W}){try{const l=navigator.hardwareConcurrency||4,Y=l<4?0:1,$=l<4?15:30,{width:H,height:N}=await y.getOptimalResolution(),p=await y.initPose(Y),s=(o==null?void 0:o.current)||document.createElement("video");s.width=H,s.height=N;const h=new J(s,{onFrame:async()=>{s.readyState===4?await p.send({image:s}):t("Camera not ready, please check permissions")},width:H,height:N,frameRate:$,facingMode:A});try{await h.start(),o!=null&&o.current||s.play(),console.log("Camera started with facingMode:",A)}catch(e){return console.error("Camera error:",e),e.name==="NotAllowedError"||e.name==="PermissionDeniedError"?t("Camera access denied. Please allow camera access."):e.name==="NotFoundError"?t("No camera found. Please connect a camera."):t("Failed to start camera. Please try again."),{stop:()=>{}}}navigator.getBattery&&(await navigator.getBattery()).level<.2&&(h.setOptions({frameRate:10}),t("Low battery, reduced frame rate"));let a=0,n=!1,c="",b=0;const k=2e3;return p.onResults(e=>{if(!e.poseLandmarks||e.poseLandmarks.length<33){c="Ensure upper body is visible",t(c);return}const r=e.poseLandmarks,m=r[11],E=r[12],I=r[13],S=r[14],G=r[15],K=r[16],_=r[23];if(m.score<f||E.score<f||I.score<f||S.score<f)return;const j=(m.y+E.y)/2,M=_.y-j,T=(u,g,w)=>{const C=Math.sqrt(Math.pow(g.x-u.x,2)+Math.pow(g.y-u.y,2)),D=Math.sqrt(Math.pow(w.x-g.x,2)+Math.pow(w.y-g.y,2)),q=Math.sqrt(Math.pow(w.x-u.x,2)+Math.pow(w.y-u.y,2));return Math.acos((C*C+D*D-q*q)/(2*C*D))*(180/Math.PI)},v=T(m,I,G),z=T(E,S,K),P=(v+z)/2;Math.abs(m.y-_.y)*100>.05&&(c="Keep back straight");const U=Date.now();U-b>=k&&(M<L&&!n?c="Go lower":P>B&&n&&(c="Push up higher"),t(c),b=U),!n&&M>L&&P<B?n=!0:n&&M<L/2&&P>160&&(n=!1,a+=1,t(`Rep ${a} completed`),y.storeProgress({userEmail:O,exerciseName:"Push-ups",currentSet:i,totalSets:d,repsCompleted:a,targetReps:x,timestamp:new Date().toISOString()}),(a>=x||i>=d)&&(h.stop(),p.close(),W({completed:!0,reps:a,feedback:`Set ${i} completed with ${a} reps`,currentSet:i,totalSets:d}),y.syncProgress(O)))}),{stop:()=>{h.stop(),p.close()}}}catch(l){return console.error("Push-ups monitoring error:",l),t("Error starting push-ups monitoring"),{stop:()=>{}}}}export{R as monitorPushUps};
