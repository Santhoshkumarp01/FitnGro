let q=0,p="standing",A=null,P=0,H=null;const b=95,D=130,E=.015,v=.005,x=160,K=async a=>{const{targetReps:e=10,totalSets:t=3,currentSet:i=1,userEmail:m,cameraFacing:o="user",videoRef:u,onFeedback:g,onComplete:h}=a;try{await F();const c=await window.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");H=await window.PoseLandmarker.createFromOptions(c,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1,minPoseDetectionConfidence:.5,minPosePresenceConfidence:.5,minTrackingConfidence:.5,outputSegmentationMasks:!1});let r=0,k=0,S=e*t,y=!0;const f=()=>{if(!(!y||!H||!u.current)){try{const s=H.detectForVideo(u.current,performance.now());if(s.landmarks&&s.landmarks.length>0){const l=_(s,{currentSetReps:r,targetRepsPerSet:e,totalReps:k,totalTargetReps:S});l.repCount>r&&(r=l.repCount,k++,r>=e&&(h({completed:!0,reps:r,feedback:`Set ${i} complete! ${r}/${e} reps`,currentSet:i}),r=0,P=0,q=0,p="standing",A=null)),g&&g(l.feedback)}}catch(s){console.error("Error processing frame:",s)}y&&requestAnimationFrame(f)}};return f(),console.log("Jump squat monitoring started"),{stop:()=>{y=!1,H&&H.close(),console.log("Jump squat monitoring stopped")}}}catch(c){throw console.error("Error initializing jump squat monitoring:",c),c}},_=(a,{currentSetReps:e,targetRepsPerSet:t,totalReps:i,totalTargetReps:m})=>{if(!a.landmarks||a.landmarks.length===0)return{feedback:"No person detected.",repCount:e};const o=a.landmarks[0],u=o[23],g=o[24],h=o[25],c=o[26],r=o[27],k=o[28],S=o[11],y=o[12];if(!u||!g||!h||!c||!r||!k||!S||!y)return{feedback:"Please position yourself correctly in the frame.",repCount:e};const f=L([o]),s=f.kneeAngle,l=f.midHipY;let n="Starting jump squats...",d=e;switch(p){case"standing":s<x?(p="descending",n="â¬‡ï¸ Descending into squat..."):n="ðŸ“ˆ Stand ready. Begin your squat.";break;case"descending":s<=b?(p="squatting",n="ðŸŽ¯ At squat depth. Prepare to jump!"):s>x?(p="standing",n="ðŸ“ˆ Back to standing. Start your squat."):n="â¬‡ï¸ Keep descending...";break;case"squatting":l!==null&&A!==null&&(A-l>E&&s>D?(p="jumping",n="ðŸš€ Jumping!",d===P&&(d++,q=d,P=d)):n="ðŸŽ¯ Hold squat position, then explode up!");break;case"jumping":l!==null&&A!==null&&(l-A>v?(p="landing",n="ðŸ›¬ Landing..."):n="ðŸš€ In the air!");break;case"landing":s>x-5&&s<x+5?(p="standing",n=`âœ… Jump Squat Completed! Reps: ${d}/${t}. Ready for next.`):s<b?(p="descending",n=`âœ… Jump Squat Completed! Reps: ${d}/${t}. Descending for next.`):n="ðŸ›¬ Stabilizing landing...";break}return A=l,d>=t&&(n="Set complete! Take a rest."),i>=m&&(n="Workout complete! Great job!"),{repCount:d,feedback:n,avgKneeAngle:Math.round(s),currentState:p,formData:f}};function w(a,e,t){const i=Math.hypot(e.x-a.x,e.y-a.y),m=Math.hypot(t.x-e.x,t.y-e.y),o=Math.hypot(t.x-a.x,t.y-a.y),u=(i**2+m**2-o**2)/(2*i*m),g=Math.max(-1,Math.min(1,u));return Math.acos(g)*(180/Math.PI)}function L(a){const e=a[0],t=e[23],i=e[24],m=e[25],o=e[26],u=e[27],g=e[28],h=e[11],c=e[12],r=w(t,m,u),k=w(i,o,g),S=(r+k)/2,y=w(h,t,m),f=w(c,i,o),s=(y+f)/2,l=Math.abs(m.x-o.x),n=Math.abs(t.x-i.x),d=n>0?l/n:1,M=(t.y+i.y)/2,R={x:(t.x+i.x)/2,y:(t.y+i.y)/2},T={x:(h.x+c.x)/2,y:(h.y+c.y)/2},C=Math.atan2(T.x-R.x,R.y-T.y)*(180/Math.PI);return{kneeAngle:S,hipAngle:s,kneeAlignment:d,torsoAngle:Math.abs(C),leftKneeAngle:r,rightKneeAngle:k,midHipY:M}}async function F(){return new Promise((a,e)=>{if(window.FilesetResolver&&window.PoseLandmarker){a();return}const t=document.createElement("script");t.type="module",t.innerHTML=`
      import {
        FilesetResolver,
        PoseLandmarker,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";
      
      window.FilesetResolver = FilesetResolver;
      window.PoseLandmarker = PoseLandmarker;
    `,t.onload=()=>{setTimeout(a,100)},t.onerror=()=>e(new Error("Failed to load MediaPipe Vision Tasks")),document.head.appendChild(t)})}export{K as monitorJumpSquats};
