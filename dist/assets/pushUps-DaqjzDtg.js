import{U as l}from"./index-6R1NXPvo.js";const L=.1,B=120,d=.5;async function X({targetReps:O,totalSets:f,currentSet:p,userEmail:x,cameraFacing:A="user",videoRef:s,onFeedback:e,onComplete:W}){try{const h=navigator.hardwareConcurrency||4,Y=h<4?0:1,$=h<4?15:30,{width:H,height:N}=await l.getOptimalResolution(),m=await l.initPose(Y),o=(s==null?void 0:s.current)||document.createElement("video");o.width=H,o.height=N;const i=await l.initCamera(o,async()=>{o.readyState===4?await m.send({image:o}):e("Camera not ready, please check permissions")});i.setOptions({width:H,height:N,frameRate:$,facingMode:A});try{await i.start(),s!=null&&s.current||o.play(),console.log("Camera started with facingMode:",A)}catch(t){return console.error("Camera error:",t),t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?e("Camera access denied. Please allow camera access."):t.name==="NotFoundError"?e("No camera found. Please connect a camera."):e("Failed to start camera. Please try again."),{stop:()=>{}}}if(navigator.getBattery)try{(await navigator.getBattery()).level<.2&&(i.setOptions({frameRate:10}),e("Low battery, reduced frame rate"))}catch{}let a=0,n=!1,c="",b=0;const k=2e3;return m.onResults(t=>{if(!t.poseLandmarks||t.poseLandmarks.length<33){c="Ensure upper body is visible",e(c);return}const r=t.poseLandmarks,u=r[11],E=r[12],I=r[13],S=r[14],G=r[15],K=r[16],_=r[23];if(u.score<d||E.score<d||I.score<d||S.score<d)return;const j=(u.y+E.y)/2,M=_.y-j,T=(g,w,y)=>{const C=Math.sqrt(Math.pow(w.x-g.x,2)+Math.pow(w.y-g.y,2)),D=Math.sqrt(Math.pow(y.x-w.x,2)+Math.pow(y.y-w.y,2)),q=Math.sqrt(Math.pow(y.x-g.x,2)+Math.pow(y.y-g.y,2));return Math.acos((C*C+D*D-q*q)/(2*C*D))*(180/Math.PI)},v=T(u,I,G),z=T(E,S,K),P=(v+z)/2;Math.abs(u.y-_.y)*100>.05&&(c="Keep back straight");const U=Date.now();U-b>=k&&(M<L&&!n?c="Go lower":P>B&&n&&(c="Push up higher"),e(c),b=U),!n&&M>L&&P<B?n=!0:n&&M<L/2&&P>160&&(n=!1,a+=1,e(`Rep ${a} completed`),l.storeProgress({userEmail:x,exerciseName:"Push-ups",currentSet:p,totalSets:f,repsCompleted:a,targetReps:O,timestamp:new Date().toISOString()}),(a>=O||p>=f)&&(i.stop(),m.close(),W({completed:!0,reps:a,feedback:`Set ${p} completed with ${a} reps`,currentSet:p,totalSets:f}),l.syncProgress(x)))}),{stop:()=>{i.stop(),m.close()}}}catch(h){return console.error("Push-ups monitoring error:",h),e("Error starting push-ups monitoring"),{stop:()=>{}}}}export{X as monitorPushUps};
