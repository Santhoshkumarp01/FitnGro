let r="standing",M=0,g=0,S=0,n=0,m=!1,w=0,p={squat:!1,pushup:!1,return:!1,jump:!1},v=null,T=null,q=null;const N=async s=>{const{targetReps:t=10,totalSets:e=3,currentSet:o=1,userEmail:h,cameraFacing:c="user",videoRef:i,onFeedback:u,onComplete:d,onPhaseChange:P}=s;try{await G(),T=await window.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"),v=await window.PoseLandmarker.createFromOptions(T,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1,minPoseDetectionConfidence:.7,minPosePresenceConfidence:.7,minTrackingConfidence:.7,outputSegmentationMasks:!1});let a=0,y=0,x=t*e;const b=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:c==="user"?"user":"environment"}});i.current&&(i.current.srcObject=b,i.current.onloadeddata=()=>{R()});const R=async()=>{if(!(!v||!i.current)){try{const f=performance.now(),F=v.detectForVideo(i.current,f),l=$(F,{currentSetReps:a,targetRepsPerSet:t,totalReps:y,totalTargetReps:x});l.repCount>a&&(a=l.repCount,y++,a>=t&&(d({completed:!0,reps:a,feedback:`Set ${o} complete! ${a}/${t} reps`,currentSet:o,partialReps:l.partialReps}),a=0,S=0,E())),u&&u(l.feedback),P&&l.phaseChanged&&P({currentPhase:l.currentPhase,completedPhases:l.completedPhases})}catch(f){console.error("Error processing video frame:",f)}q=requestAnimationFrame(R)}};return console.log("Burpee monitoring started"),{stop:()=>{q&&(cancelAnimationFrame(q),q=null),b&&b.getTracks().forEach(f=>f.stop()),i.current&&(i.current.srcObject=null),v&&v.close(),E(),console.log("Burpee monitoring stopped")},reset:()=>{E(),a=0,y=0,S=0},getStats:()=>({perfectReps:M,partialReps:g,totalReps:M+g,currentPhase:r,completedPhases:p})}}catch(a){throw console.error("Error initializing burpee monitoring:",a),a}},$=(s,{currentSetReps:t,targetRepsPerSet:e,totalReps:o,totalTargetReps:h})=>{if(!s.landmarks||s.landmarks.length===0)return{feedback:"No person detected. Please stay in camera view.",repCount:t,partialReps:g,currentPhase:r,completedPhases:p,phaseChanged:!1};const c=D(s.landmarks),i=r,u=O(c);let d=t;return u.repCompleted&&d===S&&(d++,S=d),{repCount:d,partialReps:g,feedback:u.feedback,currentPhase:r,completedPhases:{...p},phaseChanged:i!==r,avgKneeAngle:Math.round(c.avgKneeAngle),avgElbowAngle:Math.round(c.avgElbowAngle)}},D=s=>{const t=s[0],e=t[0],o=t[11],h=t[12],c=t[13],i=t[14],u=t[15],d=t[16],P=t[23],a=t[24],y=t[25],x=t[26],b=t[27],R=t[28],f=A(P,y,b),F=A(a,x,R),l=(f+F)/2,L=A(o,c,u),H=A(h,i,d),K=(L+H)/2,k=(o.y+h.y)/2,C=(P.y+a.y)/2,B=(u.y+d.y)/2,j=e.y,I=l<130&&k>C-.1,J=B>k&&Math.abs(k-C)<.15&&j>k-.1,V=l>160&&j<k-.1,_=l>150&&k<C;return{avgKneeAngle:l,avgElbowAngle:K,isSquatting:I,isInPushupPosition:J,isJumping:V,isStanding:_,shoulderHeight:k,hipHeight:C,handHeight:B,noseHeight:j}},O=s=>{n++;const t=5;let e="",o=!1;switch(r){case"standing":s.isSquatting&&n>t?(r="squatting",n=0,p.squat=!0,e="üèãÔ∏è Good squat! Now go into push-up position"):e="Ready to start! Squat down to begin your burpee";break;case"squatting":s.isInPushupPosition&&n>t?(r="pushup",n=0,m=!1,w=0,e="üí™ Perfect! In push-up position - now do the push-up!"):n>60?e="‚ö†Ô∏è Place hands on ground and extend legs back for push-up position":e="Transition to push-up position";break;case"pushup":s.avgElbowAngle<100&&!m?(w++,w>=3?(m=!0,p.pushup=!0,e="üí™ Excellent push-up! Now jump back to squat position"):e="Good form! Complete the push-up movement"):s.avgElbowAngle>=100&&(w=0,m||(e="‚ö†Ô∏è Bend your arms more for a proper push-up")),s.isSquatting&&n>t?m?(r="returning",n=0,p.return=!0,e="üîÑ Great! Back to squat - now jump up!"):(e="‚ö†Ô∏è Complete the push-up first! Bend your arms to at least 90 degrees",n=Math.max(0,n-10)):n>120&&(m?e="‚ö†Ô∏è Jump your feet back to squat position":e="‚ö†Ô∏è Do a proper push-up: bend your arms to 90 degrees or less!");break;case"returning":(s.isJumping||s.isStanding)&&n>t?(r="jumping",n=0,e="üöÄ Jump higher! Extend fully!"):n>45?e="‚ö†Ô∏è Jump up explosively from squat position!":e="Jump up from squat position";break;case"jumping":s.isStanding&&n>10?(p.squat&&p.pushup&&p.return?(M++,p.jump=!0,e=`üéâ Burpee #${M} completed! Excellent work!`,o=!0):(g++,e=`‚ö†Ô∏è Partial rep #${g} - make sure to complete all phases properly!`),E()):s.isSquatting&&n>5?(g++,r="squatting",n=0,m=!1,w=0,p={squat:!0,pushup:!1,return:!1,jump:!1},e=`‚ö†Ô∏è Partial rep #${g} - jump higher and extend fully next time!`):e="Extend fully and land on your feet";break}return r==="pushup"&&Math.abs(s.shoulderHeight-s.hipHeight)>.25&&(e="‚ö†Ô∏è Keep your body straight - avoid sagging or piking"),r==="squatting"&&s.avgKneeAngle>140&&(e="‚ö†Ô∏è Squat deeper - bend your knees more"),{feedback:e,repCompleted:o}},A=(s,t,e)=>{const o=Math.hypot(t.x-s.x,t.y-s.y),h=Math.hypot(e.x-t.x,e.y-t.y),c=Math.hypot(e.x-s.x,e.y-s.y),i=(o**2+h**2-c**2)/(2*o*h),u=Math.max(-1,Math.min(1,i));return Math.acos(u)*(180/Math.PI)},E=()=>{r="standing",n=0,m=!1,w=0,p={squat:!1,pushup:!1,return:!1,jump:!1}};async function G(){return new Promise((s,t)=>{if(window.FilesetResolver&&window.PoseLandmarker){s();return}const e=document.createElement("script");e.type="module",e.innerHTML=`
      import { FilesetResolver, PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";
      window.FilesetResolver = FilesetResolver;
      window.PoseLandmarker = PoseLandmarker;
      window.mediaPipeLoaded = true;
    `,e.onload=()=>{const o=()=>{window.mediaPipeLoaded?s():setTimeout(o,100)};o()},e.onerror=()=>t(new Error("Failed to load MediaPipe Tasks Vision")),document.head.appendChild(e)})}export{N as monitorBurpees};
