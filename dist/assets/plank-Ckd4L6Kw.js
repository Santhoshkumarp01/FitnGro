let r=!1,s=null,G=0,l=0,R=0,h=0,f=0,k=[],F=null,V=null,E=!1,T=null;const N=10,K=15,q=30,J=1e3/q,ne=async o=>{const{targetDuration:e=60,totalSets:n=3,currentSet:a=1,userEmail:p,cameraFacing:m="user",videoRef:g,onFeedback:y,onComplete:S,onProgress:w}=o;try{await oe(),V=await window.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"),F=await window.PoseLandmarker.createFromOptions(V,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1,minPoseDetectionConfidence:.5,minPosePresenceConfidence:.5,minTrackingConfidence:.5,outputSegmentationMasks:!1}),console.log("âœ… PoseLandmarker initialized successfully");let t=0,P=0;E=!0;const b=async()=>{if(!E||!F||!g.current)return;const i=performance.now();if(i-P>=J)try{const c=F.detectForVideo(g.current,i),d=X(c,{targetDuration:e,currentSetDuration:t,totalPlankTime:l,sessionCount:f});t=d.currentDuration,w&&w({currentDuration:t,targetDuration:e,totalTime:l+t,sessionCount:d.sessionCount,isActive:d.isInPlank}),t>=e&&r&&(S({completed:!0,duration:t,feedback:`Set ${a} complete! Held for ${$(t)}`,currentSet:a,totalTime:l+t}),l+=t,f++,k.push({duration:t,timestamp:new Date}),v()),y&&y(d.feedback),P=i}catch(c){console.error("Error processing frame:",c)}E&&(T=requestAnimationFrame(b))};return b(),console.log("Plank monitoring started"),{stop:()=>{if(E=!1,T&&(cancelAnimationFrame(T),T=null),r&&s!==null){const i=Date.now()/1e3-s;l+=i,f++,k.push({duration:i,timestamp:new Date})}v(),F&&F.close(),console.log("Plank monitoring stopped")},getStats:()=>({totalPlankTime:l,sessionCount:f,sessionHistory:k,currentSessionTime:r?Date.now()/1e3-s:0}),reset:()=>{if(r&&s!==null){const i=Date.now()/1e3-s;l+=i}v(),l=0,f=0,k=[],console.log("ðŸ”„ Plank timer and statistics reset")}}}catch(t){throw console.error("Error initializing plank monitoring:",t),t}},X=(o,{targetDuration:e,currentSetDuration:n,totalPlankTime:a,sessionCount:p})=>{if(!o.landmarks||o.landmarks.length===0)return ee(),{feedback:"ðŸ” Move into camera view for pose detection",currentDuration:j(),sessionCount:p,isInPlank:!1};const m=Y(o.landmarks);return{feedback:Z(m).message,currentDuration:j(),sessionCount:p,isInPlank:r,formQuality:m.isGoodForm?"good":"needs-improvement",debug:m.debug}};function Y(o){const e=o[0];e[0];const n=e[11],a=e[12],p=e[13],m=e[14],g=e[15],y=e[16],S=e[23],w=e[24],t=e[25],P=e[26],b=e[27],i=e[28],c={x:(n.x+a.x)/2,y:(n.y+a.y)/2},d={x:(p.x+m.x)/2,y:(p.y+m.y)/2},z={x:(g.x+y.x)/2,y:(g.y+y.y)/2},M={x:(S.x+w.x)/2,y:(S.y+w.y)/2},B={x:(t.x+P.x)/2,y:(t.y+P.y)/2},Q={x:(b.x+i.x)/2,y:(b.y+i.y)/2},D=d.y>c.y&&z.y>d.y,x=B.y<Q.y-.04,L=M.y-c.y,A=L<-.06,I=L>.06,_=Math.abs(c.x-d.x)<.08,O=Math.abs((M.y-c.y)/(M.x-c.x+.001)),C=O<.25;let u=[];D||u.push("ðŸ”½ Get into plank position - forearms on ground"),x||u.push("â¬†ï¸ Lift your knees off the ground"),A?u.push("â¬‡ï¸ Lower your hips - they're too high"):I&&u.push("â¬†ï¸ Raise your hips - they're sagging"),!_&&D&&u.push("ðŸ“ Position shoulders directly over elbows"),!C&&D&&x&&u.push("ðŸ“ Keep your body in a straight line");const H=D&&x&&!A&&!I,U=H&&_&&C,W={isOnForearms:D,kneesOffGround:x,hipTooHigh:A,hipTooLow:I,shouldersOverElbows:_,isBodyStraight:C,bodySlope:O.toFixed(3),hipShoulderDiff:L.toFixed(3)};return{isInPlank:H,isGoodForm:U,feedback:u.length>0?u:["ðŸŽ‰ Perfect form! Keep it up!"],debug:W}}function Z(o){const e=Date.now()/1e3;if(o.isInPlank){R++,h=0;const n=o.feedback.join(" â€¢ ");return!r&&R>=N&&(s=e,r=!0,G=0,console.log("ðŸŸ¢ Plank started!")),{message:n,type:o.isGoodForm?"good-form":"bad-form"}}else{h++,R=0;const n=o.feedback.join(" â€¢ ");if(r&&h>=K){if(s!==null){const a=e-s;l+=a,f++,k.push({duration:a,timestamp:new Date}),console.log("ðŸ”´ Plank ended. Session time:",$(a))}v()}return{message:n,type:"bad-form"}}}function ee(){if(r&&(h++,h>=K)){if(s!==null){const o=Date.now()/1e3-s;l+=o,f++,k.push({duration:o,timestamp:new Date})}v()}}function j(){return r&&s!==null?Date.now()/1e3-s:G}function v(){s=null,r=!1,G=0,R=0,h=0}function $(o){const e=Math.floor(o/60),n=Math.floor(o%60);return`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}async function oe(){return new Promise((o,e)=>{if(window.FilesetResolver&&window.PoseLandmarker){o();return}const n=document.createElement("script");n.type="module",n.innerHTML=`
      import {
        FilesetResolver,
        PoseLandmarker,
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";
      
      window.FilesetResolver = FilesetResolver;
      window.PoseLandmarker = PoseLandmarker;
      
      window.dispatchEvent(new CustomEvent('mediapipe-loaded'));
    `,window.addEventListener("mediapipe-loaded",()=>{o()},{once:!0}),n.onerror=()=>e(new Error("Failed to load MediaPipe Vision Tasks")),document.head.appendChild(n)})}export{ne as monitorPlank};
