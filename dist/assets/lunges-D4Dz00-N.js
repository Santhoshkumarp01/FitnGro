let w=!1,_=0,T=null,P=0,F=null,E=0,M=0;const D=20,C=.6,x=1e3,O=async e=>{const{targetReps:t=10,totalSets:n=3,currentSet:d=1,userEmail:a,cameraFacing:o="user",videoRef:l,canvasRef:g,onFeedback:r,onComplete:p,onTimingUpdate:i}=e;try{await I();const s=await window.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");T=await window.PoseLandmarker.createFromOptions(s,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1,minPoseDetectionConfidence:C,minPosePresenceConfidence:C,minTrackingConfidence:.5,outputSegmentationMasks:!1});let c=0,u=0,h=t*n,f=!0,k=-1;const m=g==null?void 0:g.current,L=m==null?void 0:m.getContext("2d");let K=null;L&&window.DrawingUtils&&(K=new window.DrawingUtils(L));const R=async()=>{if(!l.current||!T||!f)return;const S=l.current.currentTime;if(S===k){requestAnimationFrame(R);return}k=S;try{const y=T.detectForVideo(l.current,performance.now());if(y.landmarks&&y.landmarks.length>0){const v=y.landmarks[0];K&&L&&U(v,L,K),P++;const A=N(y,{currentSetReps:c,targetRepsPerSet:t,totalReps:u,totalTargetReps:h});A.repCount>c&&(c=A.repCount,u++,i&&i({totalLungeTime:E,averageLungeTime:M,lastLungeTime:A.lastLungeTime}),c>=t&&(p({completed:!0,reps:c,feedback:`Set ${d} complete! ${c}/${t} reps`,currentSet:d,timingStats:{totalTime:E,averageTime:M}}),c=0,_=0,P=0)),r&&r(A.feedback)}else r&&r({message:"âŒ Person not detected - step into frame",class:"warning-form"})}catch(y){console.error("âŒ Pose detection error:",y),r&&r({message:"Detection error occurred",class:"error"})}f&&requestAnimationFrame(R)};return R(),console.log("Lunge monitoring started"),{stop:()=>{f=!1,T&&T.close(),console.log("Lunge monitoring stopped")},getStats:()=>({totalTime:E,averageTime:M,totalReps:u})}}catch(s){throw console.error("Error initializing lunge monitoring:",s),s}},N=(e,{currentSetReps:t,targetRepsPerSet:n,totalReps:d,totalTargetReps:a})=>{if(!e.landmarks||e.landmarks.length===0)return{feedback:{message:"No person detected.",class:"warning-form"},repCount:t};const o=e.landmarks[0],l=o[23],g=o[24],r=o[25],p=o[26],i=o[27],s=o[28];if(o[0],!l||!g||!r||!p||!i||!s)return{feedback:{message:"Please position yourself sideways to the camera.",class:"warning-form"},repCount:t};const c=H(o),u=Date.now();let h=t,f={message:"Ready for next lunge...",class:"neutral-form"},k=0;if(c){const m=$(o);if(!w&&P>D)w=!0,F=u,f={message:"ðŸ”¥ Lunge detected! Hold the position...",class:"processing"};else if(w){const L=u-F;f={message:`${m.feedback} | Hold time: ${Math.round(L/1e3)}s`,class:m.class}}}else if(w&&P>D){const m=u-F;m>=x?(w=!1,h++,P=0,k=m,E+=m,M=E/h,f={message:`ðŸ’ª Rep completed! Time: ${Math.round(m/1e3)}s | Total: ${h}/${n}`,class:"good-form"}):(w=!1,f={message:`â±ï¸ Hold longer! Minimum ${x/1e3}s required (held ${Math.round(m/1e3)}s)`,class:"warning-form"}),F=null}else w||(f={message:"ðŸ‘€ Position yourself for a lunge",class:"neutral-form"});return h>=n&&(f={message:`Set complete! Average lunge time: ${Math.round(M/1e3)}s`,class:"good-form"}),d>=a&&(f={message:"Workout complete! Great job!",class:"good-form"}),{repCount:h,feedback:f,isInLunge:w,lastLungeTime:k}};function b(e,t,n){const d=Math.hypot(t.x-e.x,t.y-e.y),a=Math.hypot(n.x-t.x,n.y-t.y),o=Math.hypot(n.x-e.x,n.y-e.y),l=Math.acos((d**2+a**2-o**2)/(2*d*a))*(180/Math.PI);return isNaN(l)?180:l}function H(e){const t=e[23],n=e[24],d=e[25],a=e[26],o=e[27],l=e[28],g=b(t,d,o),r=b(n,a,l),p=Math.abs(g-r),i=Math.abs(o.x-l.x);return(g<135||r<135)&&p>25&&i>.08}function $(e){const t=e[23],n=e[24],d=e[25],a=e[26],o=e[27],l=e[28],g=e[0],r=b(t,d,o),p=b(n,a,l);let i=[],s="good-form";const c=r<p?"left":"right",u=c==="left"?r:p,h=c==="left"?p:r,f=c==="left"?d:a,k=c==="left"?o:l;f.x>k.x+.06&&(i.push("âš ï¸ Keep front knee behind toes"),s="poor-form"),u>130?(i.push("ðŸ“‰ Go deeper - bend front knee more"),s="warning-form"):u<60&&(i.push("â¬†ï¸ Don't go too low - maintain control"),s="warning-form"),h<130&&(i.push("ðŸ“ Keep back leg straighter"),s!=="poor-form"&&(s="warning-form"));const m={x:(t.x+n.x)/2,y:(t.y+n.y)/2};return Math.abs(g.x-m.x)>.12&&(i.push("ðŸ“ Keep torso upright"),s!=="poor-form"&&(s="warning-form")),i.length===0&&i.push("âœ… Excellent form!"),{feedback:i.join(" | "),class:s}}function U(e,t,n){t.clearRect(0,0,t.canvas.width,t.canvas.height),n.drawLandmarks(e,{radius:a=>window.DrawingUtils.lerp(a.from.z,-.15,.1,5,1)}),n.drawConnectors(e,window.PoseLandmarker.POSE_CONNECTIONS,{color:"#00FF00",lineWidth:2}),[23,24,25,26,27,28].forEach(a=>{const o=e[a];o&&(t.beginPath(),t.arc(o.x*t.canvas.width,o.y*t.canvas.height,8,0,2*Math.PI),t.fillStyle="#FF6B6B",t.fill())})}async function I(){return new Promise((e,t)=>{if(window.FilesetResolver&&window.PoseLandmarker&&window.DrawingUtils){e();return}const n=document.createElement("script");n.type="module",n.textContent=`
      import {
        FilesetResolver,
        PoseLandmarker,
        DrawingUtils
      } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";
      
      window.FilesetResolver = FilesetResolver;
      window.PoseLandmarker = PoseLandmarker;
      window.DrawingUtils = DrawingUtils;
      
      window.dispatchEvent(new Event('mediapipe-loaded'));
    `,window.addEventListener("mediapipe-loaded",()=>{e()},{once:!0}),n.onerror=()=>t(new Error("Failed to load MediaPipe Tasks Vision")),document.head.appendChild(n)})}export{O as monitorLunges};
