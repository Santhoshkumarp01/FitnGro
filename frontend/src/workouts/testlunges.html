<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lunge Rep Counter (Video Upload, WASM)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    #video { max-width: 100%; margin-bottom: 1em; }
    #feedback { font-size: 1.2em; margin-top: 1em; color: #007bff; min-height: 30px; }
    #result { font-size: 1.4em; margin-top: 1em; font-weight: bold; color: #28a745; }
    #formFeedback { font-size: 1.1em; margin-top: 1em; padding: 10px; border-radius: 5px; }
    .processing { color: #ffc107; }
    .error { color: #dc3545; }
    .good-form { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .poor-form { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .warning-form { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
  </style>
</head>
<body>
  <h2>Lunge Rep Counter (Upload Video)</h2>
  <p>Upload a video of yourself doing lunges. Make sure you're visible from the side for best detection.</p>
  <input type="file" id="fileInput" accept="video/*">
  <video id="video" controls muted></video>
  <div id="feedback"></div>
  <div id="formFeedback"></div>
  <div id="result"></div>

  <script type="module">
    import {
      FilesetResolver,
      PoseLandmarker,
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";

    let poseLandmarker, vision, processing = false;
    let animationFrameId = null;

    async function setupPoseLandmarker() {
      try {
        vision = await FilesetResolver.forVisionTasks(
          "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
            delegate: "GPU"
          },
          runningMode: "VIDEO",
          numPoses: 1,
          minPoseDetectionConfidence: 0.5,
          minPosePresenceConfidence: 0.5,
          minTrackingConfidence: 0.5,
          outputSegmentationMasks: false,
        });
        console.log("PoseLandmarker initialized successfully");
        document.getElementById('feedback').textContent = "Pose detection ready. Upload a video to analyze lunges.";
      } catch (error) {
        console.error("Failed to initialize PoseLandmarker:", error);
        document.getElementById('feedback').textContent = "Failed to load pose detection model. Please try refreshing the page.";
        document.getElementById('feedback').className = "error";
      }
    }

    function calcAngle(a, b, c) {
      const ab = Math.hypot(b.x - a.x, b.y - a.y);
      const bc = Math.hypot(c.x - b.x, c.y - b.y);
      const ac = Math.hypot(c.x - a.x, c.y - a.y);
      return Math.acos((ab**2 + bc**2 - ac**2) / (2 * ab * bc)) * (180 / Math.PI);
    }

    function calcDistance(a, b) {
      return Math.hypot(b.x - a.x, b.y - a.y);
    }

    function isLungePosition(landmarks) {
      const leftHip = landmarks[23], rightHip = landmarks[24];
      const leftKnee = landmarks[25], rightKnee = landmarks[26];
      const leftAnkle = landmarks[27], rightAnkle = landmarks[28];
      
      // Calculate knee angles
      const leftKneeAngle = calcAngle(leftHip, leftKnee, leftAnkle);
      const rightKneeAngle = calcAngle(rightHip, rightKnee, rightAnkle);
      
      // Check if one leg is significantly more bent than the other (lunge characteristic)
      const angleDifference = Math.abs(leftKneeAngle - rightKneeAngle);
      
      // Check foot separation (lunges have wider stance)
      const footSeparation = Math.abs(leftAnkle.x - rightAnkle.x);
      
      // One knee should be significantly bent (< 140Â°) and legs should be separated
      const hasLungeStance = (leftKneeAngle < 140 || rightKneeAngle < 140) && 
                            angleDifference > 20 && 
                            footSeparation > 0.1;
      
      return hasLungeStance;
    }

    function analyzeLungeForm(landmarks) {
      const leftHip = landmarks[23], rightHip = landmarks[24];
      const leftKnee = landmarks[25], rightKnee = landmarks[26];
      const leftAnkle = landmarks[27], rightAnkle = landmarks[28];
      const nose = landmarks[0];
      
      // Calculate knee angles
      const leftKneeAngle = calcAngle(leftHip, leftKnee, leftAnkle);
      const rightKneeAngle = calcAngle(rightHip, rightKnee, rightAnkle);
      
      let formFeedback = [];
      let formClass = "good-form";
      
      // Determine which leg is the front leg (more bent)
      const frontLeg = leftKneeAngle < rightKneeAngle ? 'left' : 'right';
      const frontKneeAngle = frontLeg === 'left' ? leftKneeAngle : rightKneeAngle;
      const backKneeAngle = frontLeg === 'left' ? rightKneeAngle : leftKneeAngle;
      const frontKnee = frontLeg === 'left' ? leftKnee : rightKnee;
      const frontAnkle = frontLeg === 'left' ? leftAnkle : rightAnkle;
      
      // Check front knee alignment (shouldn't go too far forward over ankle)
      if (frontKnee.x > frontAnkle.x + 0.05) {
        formFeedback.push("Keep your front knee behind your toes");
        formClass = "poor-form";
      }
      
      // Check if front knee angle is appropriate (should be around 90 degrees in deep lunge)
      if (frontKneeAngle > 120) {
        formFeedback.push("Go deeper - bend your front knee more");
        formClass = "warning-form";
      } else if (frontKneeAngle < 70) {
        formFeedback.push("Don't go too low - maintain control");
        formClass = "warning-form";
      }
      
      // Check back leg - should be relatively straight or slightly bent
      if (backKneeAngle < 140) {
        formFeedback.push("Keep your back leg straighter");
        formClass = "warning-form";
      }
      
      // Check torso position (nose should be relatively upright)
      const torsoLean = Math.abs(nose.x - ((leftHip.x + rightHip.x) / 2));
      if (torsoLean > 0.1) {
        formFeedback.push("Keep your torso upright");
        formClass = "warning-form";
      }
      
      // Good form feedback
      if (formFeedback.length === 0) {
        formFeedback.push("Good form! Keep it up!");
      }
      
      return { feedback: formFeedback, class: formClass };
    }

    function cleanup() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      processing = false;
    }

    async function analyzeVideo(video) {
      return new Promise(async (resolve, reject) => {
        document.getElementById('feedback').textContent = "Processing video...";
        document.getElementById('feedback').className = "processing";
        document.getElementById('result').textContent = "";
        document.getElementById('formFeedback').textContent = "";
        
        console.log("Processing video for lunge detection...");
        let reps = 0, isDown = false, lastFormFeedback = "";
        let framesSinceLastLunge = 0;
        const FRAMES_BETWEEN_REPS = 30; // Minimum frames between rep counts

        if (!poseLandmarker) {
          await setupPoseLandmarker();
          if (!poseLandmarker) {
            const errorMsg = "Error: Could not initialize pose detection.";
            document.getElementById('feedback').textContent = errorMsg;
            document.getElementById('feedback').className = "error";
            console.error(errorMsg);
            reject(new Error(errorMsg));
            return;
          }
        }

        // Reset video to start
        video.currentTime = 0;
        video.muted = true;
        
        // Wait for video to be ready
        await new Promise((res) => {
          const onCanPlay = () => {
            video.removeEventListener('canplay', onCanPlay);
            res();
          };
          video.addEventListener('canplay', onCanPlay);
          if (video.readyState >= 3) {
            res();
          }
        });

        const FRAME_SKIP = 2;
        let frame = 0;
        let lastProcessedTime = -1;

        function giveFeedback(msg) {
          document.getElementById('feedback').textContent = msg;
          document.getElementById('feedback').className = "processing";
          console.log("Feedback:", msg);
        }

        function giveFormFeedback(feedback, className) {
          if (feedback !== lastFormFeedback) {
            document.getElementById('formFeedback').textContent = feedback;
            document.getElementById('formFeedback').className = className;
            lastFormFeedback = feedback;
          }
        }

        function processFrame() {
          try {
            // Check if video has ended
            if (video.ended || video.currentTime >= video.duration) {
              const resultText = `Analysis Complete - Lunges completed: ${reps}`;
              document.getElementById('result').textContent = resultText;
              document.getElementById('feedback').textContent = "Analysis complete.";
              document.getElementById('feedback').className = "";
              console.log("Lunge analysis complete.");
              console.log("Final Results:", resultText);
              
              video.pause();
              cleanup();
              resolve({ reps });
              return;
            }

            framesSinceLastLunge++;

            // Only process every nth frame and avoid processing the same timestamp twice
            if (frame % FRAME_SKIP === 0 && video.currentTime !== lastProcessedTime) {
              lastProcessedTime = video.currentTime;
              
              try {
                const results = poseLandmarker.detectForVideo(video, performance.now());
                if (results.landmarks && results.landmarks.length > 0) {
                  const landmarks = results.landmarks[0];
                  
                  // Check if current pose is a lunge
                  const isCurrentlyLunge = isLungePosition(landmarks);
                  
                  if (isCurrentlyLunge) {
                    // Analyze form and give feedback
                    const formAnalysis = analyzeLungeForm(landmarks);
                    giveFormFeedback(formAnalysis.feedback.join(", "), formAnalysis.class);
                    
                    if (!isDown && framesSinceLastLunge > FRAMES_BETWEEN_REPS) {
                      isDown = true;
                      giveFeedback("Lunge position detected");
                    }
                  } else {
                    // Not in lunge position
                    if (isDown && framesSinceLastLunge > FRAMES_BETWEEN_REPS) {
                      isDown = false;
                      reps++;
                      framesSinceLastLunge = 0;
                      giveFeedback(`Lunge completed: ${reps}`);
                      giveFormFeedback("Return to starting position", "");
                    } else if (!isDown) {
                      giveFormFeedback("Get into lunge position", "");
                    }
                  }
                } else {
                  giveFormFeedback("Person not detected clearly", "warning-form");
                }
              } catch (error) {
                console.error("Error processing frame:", error);
              }
            }
            
            frame++;
            
            // Continue processing if video is still playing
            if (!video.ended && video.currentTime < video.duration) {
              animationFrameId = requestAnimationFrame(processFrame);
            } else {
              processFrame();
            }
            
          } catch (error) {
            console.error("Error in processFrame:", error);
            document.getElementById('feedback').textContent = "Error during processing";
            document.getElementById('feedback').className = "error";
            cleanup();
            reject(error);
          }
        }

        // Start processing
        try {
          await video.play();
          processFrame();
        } catch (error) {
          console.error("Error starting video playback:", error);
          document.getElementById('feedback').textContent = "Error starting video playback";
          document.getElementById('feedback').className = "error";
          cleanup();
          reject(error);
        }
      });
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      if (processing) {
        console.log("Already processing a video. Please wait.");
        document.getElementById('feedback').textContent = "Already processing a video. Please wait.";
        return;
      }
      
      cleanup();
      
      const file = e.target.files[0];
      if (!file) return;
      
      document.getElementById('result').textContent = "";
      document.getElementById('feedback').textContent = "Loading video...";
      document.getElementById('formFeedback').textContent = "";
      
      const url = URL.createObjectURL(file);
      const video = document.getElementById('video');
      video.src = url;
      
      video.onloadeddata = async () => {
        try {
          processing = true;
          console.log("Starting lunge analysis...");
          const results = await analyzeVideo(video);
          console.log("Analysis completed with results:", results);
        } catch (error) {
          console.error("Video analysis failed:", error);
          document.getElementById('feedback').textContent = "Video analysis failed: " + error.message;
          document.getElementById('feedback').className = "error";
        } finally {
          processing = false;
          URL.revokeObjectURL(url);
        }
      };

      video.onerror = (error) => {
        console.error("Video loading error:", error);
        document.getElementById('feedback').textContent = "Error loading video file";
        document.getElementById('feedback').className = "error";
        processing = false;
        URL.revokeObjectURL(url);
      };
    });

    // Initialize the pose landmarker on page load
    setupPoseLandmarker();
  </script>
</body>
</html>